---
import { ClientRouter } from "astro:transitions";
import "../styles/global.css";
import { Navbar } from "../components/layout/Navbar";
import { MobileBottomNav } from "../components/layout/MobileBottomNav";
import { ToasterProvider } from "../components/ToasterProvider";
import { optionalAuth } from "../lib/middleware/auth.middleware";
import { isFeatureEnabled } from "@/lib/feature-flags";

interface Props {
  title?: string;
  showNavbar?: boolean;
}

const { title = "10x Astro Starter", showNavbar = true } = Astro.props;

// Check if user is authenticated
const userId = await optionalAuth(Astro.locals.supabase);
const isAuthenticated = !!userId;
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width" />
    <link rel="icon" type="image/png" href="/favicon.png" />
    <meta name="generator" content={Astro.generator} />
    <title>{title}</title>
    <ClientRouter />
  </head>
  <body>
    {
      isFeatureEnabled("collections") && (
        <div class="bg-yellow-400 text-black text-center p-2 font-bold">
          TEST MODE: Flaga 'collections' jest włączona.
        </div>
      )
    }
    {showNavbar && <Navbar transition:persist client:load isAuthenticated={isAuthenticated} />}
    <main
      id="main-content"
      data-scroll="content"
      class:list={[
        "main-content",
        "overflow-hidden",
        { "with-navbar": showNavbar, "with-mobile-nav": isAuthenticated },
      ]}
    >
      <slot />
    </main>
    {isAuthenticated && <MobileBottomNav transition:persist client:load />}
    <ToasterProvider transition:persist client:load />

    <script is:inline>
      /* eslint-disable */
      (function () {
        function initializeScroll() {
          const mainContent = document.getElementById("main-content");
          if (!mainContent) return false;
          const scrollable = mainContent.querySelector(".overflow-auto");
          if (!scrollable) return false;
          scrollable.offsetHeight; // Force reflow
          scrollable.scrollTop = 1;
          requestAnimationFrame(function () {
            scrollable.scrollTop = 0;
          });
          return true;
        }
        const observer = new MutationObserver(function () {
          if (initializeScroll()) observer.disconnect();
        });
        const mainContent = document.getElementById("main-content");
        if (mainContent) observer.observe(mainContent, { childList: true, subtree: true });
        setTimeout(function () {
          initializeScroll();
          observer.disconnect();
        }, 1000);
        document.addEventListener("astro:page-load", initializeScroll);
      })();
      /* eslint-enable */
    </script>
  </body>
</html>

<style is:global>
  /* Layout structure - simplified approach */
  html,
  body {
    margin: 0;
    padding: 0;
    height: 100%;
    width: 100%;
  }

  /* Main content wrapper - container for scrolling content */
  #main-content {
    height: 100vh;
    width: 100%;
  }

  #main-content.with-navbar {
    height: calc(100vh - 57px); /* 57px = navbar height (56px) + border (1px) */
  }

  #main-content.with-mobile-nav {
    height: calc(100vh - 64px); /* 64px = mobile bottom nav height on mobile screens */
  }

  @media (min-width: 768px) {
    /* Reset mobile nav padding on desktop */
    #main-content.with-mobile-nav {
      height: 100vh;
    }
  }

  #main-content.with-navbar.with-mobile-nav {
    height: calc(100vh - 57px - 64px); /* navbar + mobile bottom nav */
  }

  @media (min-width: 768px) {
    #main-content.with-navbar.with-mobile-nav {
      height: calc(100vh - 57px); /* only navbar on desktop */
    }
  }

  /* Scrollbar styles moved to global.css for better specificity */
</style>
