---
import "../../styles/global.css";
import SummaryDisplay from "../../components/public-note/SummaryDisplay.astro";
import GoalStatusBadge from "../../components/public-note/GoalStatusBadge.astro";
import MeetingDateDisplay from "../../components/public-note/MeetingDateDisplay.astro";
import ErrorState from "../../components/public-note/ErrorState.astro";
import type { PublicNoteDTO } from "../../types";

// Disable prerendering - this is a dynamic SSR page
export const prerender = false;

// Extract token from URL params
const { token } = Astro.params;

// Fetch public note data from API
let publicNote: PublicNoteDTO | null = null;
let errorCode: number | null = null;

try {
  // Make server-side API call
  const apiUrl = new URL(`/api/share/${token}`, Astro.url.origin);
  const response = await fetch(apiUrl.toString());

  if (response.ok) {
    publicNote = await response.json();
  } else {
    // Capture error code for error state display
    errorCode = response.status;
  }
} catch (error) {
  // Handle fetch errors as 500
  // eslint-disable-next-line no-console
  console.error("Failed to fetch public note:", error);
  errorCode = 500;
}

// Helper function to get valid error code for ErrorState component
const getErrorCode = (code: number | null): 404 | 429 | 500 => {
  if (code === 404 || code === 429) return code;
  return 500;
};
---

<!doctype html>
<html lang="pl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width" />
    <link rel="icon" type="image/png" href="/favicon.png" />
    <meta name="generator" content={Astro.generator} />

    <!-- SEO protection - prevent indexing -->
    <meta name="robots" content="noindex, nofollow" />

    <title>Publiczne podsumowanie - 10xNotes</title>
  </head>
  <body class="min-h-screen">
    {
      errorCode ? (
        <ErrorState code={getErrorCode(errorCode)} />
      ) : publicNote ? (
        <div class="container mx-auto px-4 py-16 max-w-3xl">
          <article
            class="rounded-2xl border border-glass-border bg-linear-to-b from-glass-bg-from to-glass-bg-to p-8 shadow-2xl backdrop-blur-xl"
            data-testid="public-note-page"
          >
            {/* Header with goal status badge */}
            <div class="flex items-start justify-between mb-6">
              <h1 class="text-2xl font-bold text-glass-text flex-1" data-testid="public-note-page-title">
                Publiczne podsumowanie
              </h1>
              <GoalStatusBadge value={publicNote.goal_status} />
            </div>

            {/* Meeting date */}
            <MeetingDateDisplay meetingDate={publicNote.meeting_date} />

            {/* Summary text */}
            <SummaryDisplay text={publicNote.summary_text} />

            {/* Footer with created date */}
            <div class="mt-8 pt-6 border-t border-glass-border">
              <p class="text-sm text-glass-text-muted">
                Link utworzony:{" "}
                <time datetime={publicNote.created_at}>
                  {new Date(publicNote.created_at).toLocaleDateString("pl-PL", {
                    year: "numeric",
                    month: "long",
                    day: "numeric",
                    hour: "2-digit",
                    minute: "2-digit",
                  })}
                </time>
              </p>
            </div>

            {/* CTA to homepage */}
            <div class="mt-6 text-center">
              <a
                href="/"
                class="btn-public-cta inline-block px-6 py-3 rounded-lg"
                data-testid="public-note-page-cta-link"
              >
                Przejd≈∫ do 10xNotes
              </a>
            </div>
          </article>
        </div>
      ) : null
    }
  </body>
</html>

<style is:global>
  /* Custom scrollbar */
  *::-webkit-scrollbar {
    width: 12px;
    height: 12px;
  }

  *::-webkit-scrollbar-track {
    background: transparent;
  }

  *::-webkit-scrollbar-thumb {
    background: linear-gradient(to bottom, #9333ea, #db2777);
    border-radius: 6px;
  }

  *::-webkit-scrollbar-thumb:hover {
    background: linear-gradient(to bottom, #a855f7, #ec4899);
  }

  /* Firefox */
  * {
    scrollbar-width: thin;
    scrollbar-color: #9333ea transparent;
  }

  /* Public page background - matches app gradient theme */
  body {
    background: linear-gradient(to bottom right, var(--gradient-from), var(--gradient-via), var(--gradient-to));
  }

  /* CTA Button - gradient style matching app theme */
  .btn-public-cta {
    background: linear-gradient(to right, var(--gradient-button-from), var(--gradient-button-to));
    color: white;
    font-weight: 600;
    box-shadow:
      0 10px 15px -3px rgb(0 0 0 / 0.1),
      0 4px 6px -4px rgb(0 0 0 / 0.1);
    transition: all 200ms ease-in-out;
    outline: none;
  }

  .btn-public-cta:hover {
    background: linear-gradient(to right, rgb(147 51 234), rgb(219 39 119));
    box-shadow:
      0 20px 25px -5px rgb(0 0 0 / 0.1),
      0 8px 10px -6px rgb(0 0 0 / 0.1);
  }

  .btn-public-cta:focus-visible {
    outline: 3px solid var(--ring);
    outline-offset: 2px;
  }
</style>
