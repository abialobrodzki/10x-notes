---
import Layout from "@/layouts/Layout.astro";
import ResetPasswordPageWithProvider from "@/components/ResetPasswordPageWithProvider";

// Disable prerendering for dynamic URL parameter validation
export const prerender = false;

// Server-side validation of token and type parameters
const url = new URL(Astro.request.url);
const token = url.searchParams.get("token");
const type = url.searchParams.get("type");

// Redirect to forgot-password with error if token is missing or invalid
if (!token || type !== "recovery") {
  return Astro.redirect("/forgot-password?error=invalid_token");
}

// Server-side auth check - redirect authenticated users before HTML is sent
// This prevents showing reset password page after browser back button
const {
  data: { user },
} = await Astro.locals.supabase.auth.getUser();
if (user && user.email) {
  return Astro.redirect("/");
}

// Prevent caching of auth pages to avoid showing them via browser back button
Astro.response.headers.set("Cache-Control", "no-store, must-revalidate, no-cache, private");
Astro.response.headers.set("Pragma", "no-cache");
---

<Layout title="Ustawianie nowego hasÅ‚a - 10xNotes">
  <ResetPasswordPageWithProvider token={token} client:load />
</Layout>
