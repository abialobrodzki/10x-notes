---
import Layout from "@/layouts/Layout.astro";
import ResetPasswordPageWithProvider from "@/components/ResetPasswordPageWithProvider";

// Disable prerendering for dynamic URL parameter validation
export const prerender = false;

// Server-side auth check
// The reset-password page can be accessed in two ways:
// 1. User clicks password reset link from email (Supabase establishes session via /auth/v1/verify)
// 2. User already has a valid session (should redirect to home)
const {
  data: { session },
} = await Astro.locals.supabase.auth.getSession();
const user = session?.user;

// If user is already authenticated (has session), redirect to home
if (user && user.email && session) {
  return Astro.redirect("/");
}

// If no session and no token in URL, redirect to forgot-password
// This handles the case where user lands on reset-password without valid auth
const url = new URL(Astro.request.url);
const token = url.searchParams.get("token");
if (!token && !session) {
  return Astro.redirect("/forgot-password?error=invalid_token");
}

// Prevent caching of auth pages to avoid showing them via browser back button
Astro.response.headers.set("Cache-Control", "no-store, must-revalidate, no-cache, private");
Astro.response.headers.set("Pragma", "no-cache");
---

<Layout title="Ustawianie nowego hasÅ‚a - 10xNotes">
  <ResetPasswordPageWithProvider token={token || ""} client:load />
</Layout>
